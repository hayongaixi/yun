name: macOS VNC Server

on:
  workflow_dispatch:

jobs:
  macos-vnc:
    runs-on: macos-latest
    timeout-minutes: 3600

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install dependencies
        run: brew install jq

      - name: Install Tailscale
        run: |
          VERSION=$(curl -sSL https://pkgs.tailscale.com/stable/?mode=json | jq -r .Version)
          curl -fsSL "https://pkgs.tailscale.com/stable/Tailscale-${VERSION}.pkg" -o tailscale.pkg
          sudo installer -pkg tailscale.pkg -target /
          nohup sudo tailscaled >/tmp/tailscaled.log 2>&1 & disown
          sleep 3

      - name: Connect to Tailscale
        run: |
          sudo tailscale up --authkey=${{ secrets.TAILSCALE_AUTH_KEY }} --hostname=gh-runner-${GITHUB_RUN_ID}
          echo "TAILSCALE_IP=$(tailscale ip -4)" >> "$GITHUB_ENV"

      - name: Configure VNC Server
        run: |
          PASS=$(tr -dc 'A-Za-z0-9!@#$%^&*' </dev/urandom | head -c 16)
          echo "VNC_PASSWORD=$PASS" >> "$GITHUB_ENV"
          HEX_PASS=$(echo -n "$PASS" | xxd -p -c 1000 | tr -d '\n')
          sudo defaults write /Library/Preferences/com.apple.VNCServer Password -data "$HEX_PASS"
          sudo defaults write /Library/Preferences/com.apple.VNCServer LegacyAuthenticationEnabled -bool true
          sudo /System/Library/CoreServices/RemoteManagement/ARDAgent.app/Contents/Resources/kickstart -activate -configure -access -on -restart -agent -privs -all -allowAccessFor -allUsers
          sudo launchctl load -w /System/Library/LaunchDaemons/com.apple.screensharing.plist

      - name: Verify VNC Connection
        run: |
          echo "Tailscale IP: $TAILSCALE_IP"
          nc -z -v "$TAILSCALE_IP" 5900

      - name: Keep Connection Alive
        run: |
          echo "=== VNC ACCESS INFORMATION ==="
          echo "Address: ${TAILSCALE_IP}:5900"
          echo "Password: ${VNC_PASSWORD}"
          echo "Desktop: macOS"
          echo "=============================="
          while true; do
            echo "[$(date)] VNC Active - Cancel workflow to terminate"
            sleep 300
          done
