name: macOS VNC Server

on:
  workflow_dispatch:

jobs:
  macos-vnc:
    runs-on: macos-latest
    timeout-minutes: 3600

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Enable Screen Sharing (VNC)
        run: |
          # 启用系统VNC服务
          sudo /System/Library/CoreServices/RemoteManagement/ARDAgent.app/Contents/Resources/kickstart -activate -configure -access -on \
            -configure -allowAccessFor -allUsers -configure -restart -agent -privs -all
          
          # 生成随机VNC密码
          VNC_PASS=$(LC_CTYPE=C tr -dc 'A-Za-z0-9!@#$%^&*' </dev/urandom | head -c 16)
          echo "VNC_PASSWORD=$VNC_PASS" >> "$GITHUB_ENV"
          
          # 设置VNC密码
          echo -n "$VNC_PASS" | sudo /System/Library/CoreServices/RemoteManagement/ARDAgent.app/Contents/Resources/kickstart -configure -clientopts -setvnclegacy -vnclegacy yes \
            -configure -clientopts -setvncpw -vncpw -
          
          # 确保VNC服务启动
          sudo /System/Library/CoreServices/RemoteManagement/ARDAgent.app/Contents/Resources/kickstart -restart -agent

      - name: Install Tailscale
        run: |
          # 安装Tailscale
          brew install tailscale
          
          # 启动Tailscale服务
          sudo tailscale up --authkey=${{ secrets.TAILSCALE_AUTH_KEY }} --hostname=gh-macos-runner-${GITHUB_RUN_ID}
          
          # 获取Tailscale IP
          TAILSCALE_IP=$(tailscale ip -4)
          echo "TAILSCALE_IP=$TAILSCALE_IP" >> "$GITHUB_ENV"

      - name: Verify VNC Service
        run: |
          # 检查VNC端口是否监听
          lsof -i :5900 || true
          nc -z -v "$TAILSCALE_IP" 5900

      - name: Keep Connection Alive
        run: |
          echo "=== VNC ACCESS INFORMATION ==="
          echo "Address: vnc://${TAILSCALE_IP}:5900"
          echo "Username: runner"
          echo "Password: ${VNC_PASSWORD}"
          echo "Desktop: macOS"
          echo "=============================="
          while true; do
            echo "[$(date)] VNC Active - Cancel workflow to terminate"
            sleep 300
          done
